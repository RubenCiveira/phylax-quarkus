/* @autogenerated */
package net.civeira.phylax.common.infrastructure.exceptionmapper;

import java.util.List;
import java.util.Locale;

import jakarta.ws.rs.core.HttpHeaders;
import jakarta.ws.rs.core.Response;
import jakarta.ws.rs.ext.ExceptionMapper;
import jakarta.ws.rs.ext.Provider;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import net.civeira.phylax.common.exception.AbstractFailsException;

/**
 * Maps validation failures to HTTP 422 responses.
 *
 * This mapper converts {@link AbstractFailsException} into a standardized response. It chooses the
 * locale from request headers to localize failure messages. Responses include a list of localized
 * errors grouped by error code. This is used by REST endpoints to report constraint violations
 * consistently.
 */
@Slf4j
@Provider
@RequiredArgsConstructor
public class AbstractFailMapper implements ExceptionMapper<AbstractFailsException> {
  private final HttpHeaders headers;

  /**
   * Converts a validation failure exception into an HTTP response.
   *
   * The mapper determines the preferred locale from Accept-Language headers. It builds a 422
   * response with localized validation errors as the entity. Logging behavior varies based on log
   * level for diagnostics.
   *
   * @param exception validation failure exception
   * @return HTTP response containing localized errors
   */
  @Override
  public Response toResponse(AbstractFailsException exception) {
    if (log.isDebugEnabled()) {
      log.info("constraint exception", exception);
    } else if (log.isInfoEnabled()) {
      log.info("constraint fail");
    }
    List<Locale> acceptables = headers.getAcceptableLanguages();
    Locale locale =
        acceptables.isEmpty() ? Locale.getDefault() : headers.getAcceptableLanguages().get(0);

    return Response.status(422).entity(exception.localize(locale, true)).build();
  }
}
