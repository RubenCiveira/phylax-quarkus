/* @autogenerated */
package net.civeira.phylax.common.infrastructure.migration;

/**
 * SQL dialect implementation for MySQL and MariaDB migrations.
 *
 * It provides vendor-specific DDL and DML for migration log and lock tables. The dialect adapts
 * syntax to MySQL functions like NOW() and INSERT IGNORE. This is used by the migration manager
 * when a MySQL-compatible driver is detected.
 */
public class MySQLDialect implements SQLDialect {

  /**
   * Builds the SQL to create the migration log table for MySQL.
   *
   * The log table stores filename, checksum, and error metadata. It uses DATETIME for execution
   * timestamps.
   *
   * @param name table name
   * @return SQL statement for creating the log table
   */
  @Override
  public String createLogTable(String name) {
    return "CREATE TABLE IF NOT EXISTS " + name
        + " (name VARCHAR(250), filename VARCHAR(250), md5sum CHAR(64), execution DATETIME,error VARCHAR(250) );";
  }

  /**
   * Builds the SQL to create the migration lock table for MySQL.
   *
   * The lock table uses a tinyint flag to represent lock state. This table coordinates concurrent
   * migration execution.
   *
   * @param name table name
   * @return SQL statement for creating the lock table
   */
  @Override
  public String createLockTable(String name) {
    return "CREATE TABLE IF NOT EXISTS " + name
        + " (id INT PRIMARY KEY, locked TINYINT(1),granted DATETIME);";
  }

  /**
   * Builds the SQL to insert the lock row for MySQL.
   *
   * INSERT IGNORE ensures the row exists without raising errors. This establishes a single row used
   * for lock coordination.
   *
   * @param name table name
   * @return SQL statement for inserting the lock row
   */
  @Override
  public String insertLock(String name) {
    return "INSERT IGNORE INTO " + name + " (id, locked, granted) VALUES (1, 0, NULL);";
  }

  /**
   * Builds SQL to record a successful migration in MySQL.
   *
   * The statement updates an existing entry or inserts a new one. It uses NOW() to record the
   * execution time.
   *
   * @param name table name
   * @param exists whether the entry already exists
   * @return SQL statement to mark success
   */
  @Override
  public String markOkSql(String name, boolean exists) {
    return exists
        ? "UPDATE " + name
            + " SET md5sum=?, error=NULL, execution=NOW() WHERE name=? AND filename=?"
        : "INSERT INTO " + name
            + " (md5sum, error, name, filename, execution) VALUES (?, NULL, ?, ?, NOW())";
  }

  /**
   * Builds SQL to record a failed migration in MySQL.
   *
   * The statement updates an existing entry or inserts a new one. It uses NOW() to record the
   * execution time.
   *
   * @param name table name
   * @param exists whether the entry already exists
   * @return SQL statement to mark failure
   */
  @Override
  public String markFailSql(String name, boolean exists) {
    return exists
        ? "UPDATE " + name + " SET md5sum=?, error=?, execution=NOW() WHERE name=? AND filename=?"
        : "INSERT INTO " + name
            + " (md5sum, error, name, filename, execution) VALUES (?, ?, ?, ?, NOW())";
  }

}
