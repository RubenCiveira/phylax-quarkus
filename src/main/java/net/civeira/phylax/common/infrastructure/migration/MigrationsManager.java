/* @autogenerated */
package net.civeira.phylax.common.infrastructure.migration;

import java.sql.SQLException;
import java.util.Map;
import java.util.Optional;

import javax.sql.DataSource;

import io.agroal.api.AgroalDataSource;
import io.agroal.api.configuration.supplier.AgroalConnectionFactoryConfigurationSupplier;
import io.agroal.api.configuration.supplier.AgroalConnectionPoolConfigurationSupplier;
import io.agroal.api.configuration.supplier.AgroalDataSourceConfigurationSupplier;
import io.agroal.api.security.NamePrincipal;
import io.agroal.api.security.SimplePassword;
import io.quarkus.runtime.StartupEvent;
import io.smallrye.config.ConfigMapping;
import jakarta.annotation.Priority;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.enterprise.event.Observes;
import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.infrastructure.sql.UncheckedSqlException;

/**
 * Coordinates database migrations at application startup.
 *
 * The manager builds or reuses a datasource and triggers migration execution. It supports optional
 * separate JDBC settings for migration operations. Migrations are executed during the startup phase
 * with configurable priority. This class wraps SQL errors into {@link UncheckedSqlException} for
 * uniform handling.
 */
@ApplicationScoped
@RequiredArgsConstructor
public class MigrationsManager {
  private static final Map<String, String> DB_KIND_TO_DRIVER =
      Map.of("postgresql", "org.postgresql.Driver", "mysql", "com.mysql.cj.jdbc.Driver", "mariadb",
          "org.mariadb.jdbc.Driver", "h2", "org.h2.Driver", "oracle", "oracle.jdbc.OracleDriver",
          "sqlserver", "com.microsoft.sqlserver.jdbc.SQLServerDriver");

  /**
   * Configuration for an optional JDBC datasource used only for migrations.
   *
   * This allows migrations to run on a separate connection or credentials. Each property is
   * optional and falls back to the main datasource when absent. Values are sourced from the
   * application configuration mapping.
   */
  public static interface JdbcConfig {
    Optional<String> url();

    Optional<Integer> maxSize();

    Optional<Integer> minSize();
  }

  /**
   * Configuration mapping for migration settings.
   *
   * It allows specifying a separate JDBC configuration, DB kind, and location. The group identifier
   * scopes migration execution across environments. Values are optional and fall back to sensible
   * defaults.
   */
  @ConfigMapping(prefix = "app.migration")
  public static interface MigrationsConfig {
    Optional<JdbcConfig> jdbc();

    Optional<String> dbKind();

    Optional<String> username();

    Optional<String> password();

    Optional<String> location();

    Optional<String> group();
  }

  private final MigrationsConfig config;
  private final DataSource source;

  /**
   * Executes migrations during application startup.
   *
   * The method resolves a migration datasource when configured, otherwise uses the default. It
   * creates a {@link Migrations} instance and runs pending scripts. SQL errors are wrapped into
   * {@link UncheckedSqlException}.
   *
   * @param init startup event triggering migration execution
   */
  public void onInit(@Observes @Priority(Migrations.MIGRATION_PHASE_PRIORITY) StartupEvent init) {
    DataSource migrationsSource = config.jdbc().flatMap(JdbcConfig::url).map(url -> {
      String driverClassName = DB_KIND_TO_DRIVER.get(config.dbKind().orElse(""));

      AgroalDataSourceConfigurationSupplier configurationSupplier =
          new AgroalDataSourceConfigurationSupplier();
      AgroalConnectionPoolConfigurationSupplier connectionPoolConfiguration =
          configurationSupplier.connectionPoolConfiguration();
      connectionPoolConfiguration.maxSize(config.jdbc().get().maxSize().orElse(1))
          .minSize(config.jdbc().get().minSize().orElse(1));
      // Configurar la conexión mínima
      AgroalConnectionFactoryConfigurationSupplier connectionFactoryConfiguration =
          connectionPoolConfiguration.connectionFactoryConfiguration();
      connectionFactoryConfiguration.jdbcUrl(url)
          .principal(new NamePrincipal(config.username().orElse("")))
          .credential(new SimplePassword(config.password().orElse("")))
          .connectionProviderClassName(driverClassName);
      try {
        return (DataSource) AgroalDataSource.from(configurationSupplier.get());
      } catch (SQLException e) {
        throw new UncheckedSqlException(e);
      }
    }).orElseGet(() -> source);
    try (Migrations mig = new Migrations(migrationsSource.getConnection(),
        config.location().orElse("db/migration/changelog.txt"), config.group().orElse("-"))) {
      mig.runMigrations();
    } catch (SQLException ex) {
      throw new UncheckedSqlException(ex);
    }
  }
}
