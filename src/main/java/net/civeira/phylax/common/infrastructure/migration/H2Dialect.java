/* @autogenerated */
package net.civeira.phylax.common.infrastructure.migration;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.Duration;

/**
 * SQL dialect implementation for H2 database migrations.
 *
 * It provides DDL and DML statements compatible with H2 syntax. The dialect adapts lock semantics
 * and timestamp functions to H2. This is used by the migration manager when H2 is detected.
 *
 */
public class H2Dialect implements SQLDialect {

  /**
   * Builds the SQL to create the migration log table for H2.
   *
   * H2 supports IF NOT EXISTS and TIMESTAMP columns for execution time. The table stores filename,
   * checksum, and error information.
   *
   * @param name table name
   * @return SQL statement for creating the log table
   */
  @Override
  public String createLogTable(String name) {
    return "CREATE TABLE IF NOT EXISTS " + name
        + " (name VARCHAR(250), filename VARCHAR(250),md5sum CHAR(64),execution TIMESTAMP,error VARCHAR(250));";
  }

  /**
   * Builds the SQL to create the migration lock table for H2.
   *
   * The lock table uses a boolean flag and timestamp grant time. This table coordinates concurrent
   * migration execution.
   *
   * @param name table name
   * @return SQL statement for creating the lock table
   */
  @Override
  public String createLockTable(String name) {
    return "CREATE TABLE IF NOT EXISTS " + name
        + " (id INT PRIMARY KEY,locked BOOLEAN,granted TIMESTAMP);";
  }

  /**
   * Builds the SQL to insert or update the lock row for H2.
   *
   * H2 supports MERGE INTO for upsert semantics on the lock row. This ensures a single row exists
   * for lock coordination.
   *
   * @param name table name
   * @return SQL statement for inserting the lock row
   */
  @Override
  public String insertLock(String name) {
    return "MERGE INTO " + name + " (id, locked, granted) KEY (id) VALUES (1, FALSE, NULL);";
  }

  /**
   * Builds the SQL to release the lock row for H2.
   *
   * This clears the lock flag and the granted timestamp. It is used after migration execution
   * completes.
   *
   * @param name table name
   * @return SQL statement for releasing the lock
   */
  @Override
  public String releaseLock(String name) {
    return "UPDATE " + name + " SET locked = FALSE, granted = NULL WHERE id = 1";
  }

  /**
   * Builds SQL to record a successful migration in H2.
   *
   * The statement updates an existing entry or inserts a new one. It uses CURRENT_TIMESTAMP to
   * record the execution time.
   *
   * @param name table name
   * @param exists whether the entry already exists
   * @return SQL statement to mark success
   */
  @Override
  public String markOkSql(String name, boolean exists) {
    return exists
        ? "UPDATE " + name
            + " SET md5sum=?, error=NULL, execution=CURRENT_TIMESTAMP WHERE name=? AND filename=?"
        : "INSERT INTO " + name
            + " (md5sum, error, name, filename, execution) VALUES (?, NULL, ?, ?, CURRENT_TIMESTAMP)";
  }

  /**
   * Builds SQL to record a failed migration in H2.
   *
   * The statement updates an existing entry or inserts a new one. It uses CURRENT_TIMESTAMP to
   * record the execution time.
   *
   * @param name table name
   * @param exists whether the entry already exists
   * @return SQL statement to mark failure
   */
  @Override
  public String markFailSql(String name, boolean exists) {
    return exists
        ? "UPDATE " + name
            + " SET md5sum=?, error=?, execution=CURRENT_TIMESTAMP WHERE name=? AND filename=?"
        : "INSERT INTO " + name
            + " (md5sum, error, name, filename, execution) VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)";
  }

  /**
   * Builds SQL to acquire the lock in H2.
   *
   * The lock flag is set to true and the grant timestamp is updated. This is called before
   * executing migrations.
   *
   * @param name table name
   * @return SQL statement to acquire the lock
   */
  @Override
  public String updateLock(String name) {
    return "UPDATE " + name + " SET locked = TRUE, granted = CURRENT_TIMESTAMP WHERE id = 1";
  }

  /**
   * Interprets the lock row for H2 using a boolean lock flag.
   *
   * The lock is considered active when the flag is true and not expired. Expiration is checked
   * using the provided duration window.
   *
   * @param rs result set containing lock fields
   * @param duration lock validity duration
   * @return true when the lock is active and not expired
   * @throws SQLException when reading the result set fails
   */
  @Override
  public boolean interpretLocked(ResultSet rs, Duration duration) throws SQLException {
    return rs.getBoolean("locked") && stillGranted(rs, duration);
  }
}
