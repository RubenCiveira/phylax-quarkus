/* @autogenerated */
package net.civeira.phylax.common.infrastructure.migration;

/**
 * SQL dialect implementation for Oracle migrations.
 *
 * It provides PL/SQL blocks for creating tables when they do not exist. The dialect uses SYSDATE
 * for execution timestamps and numeric lock flags. This is used by the migration manager when an
 * Oracle driver is detected.
 *
 */
public class OracleDialect implements SQLDialect {

  /**
   * Builds the SQL to create the migration log table for Oracle.
   *
   * Oracle requires PL/SQL blocks to handle conditional table creation. The table stores filename,
   * checksum, and error metadata.
   *
   * @param name table name
   * @return SQL statement for creating the log table
   */
  @Override
  public String createLogTable(String name) {
    return "BEGIN EXECUTE IMMEDIATE 'CREATE TABLE " + name
        + " (name VARCHAR2(250),filename VARCHAR2(250),md5sum CHAR(64), execution TIMESTAMP,error VARCHAR2(250))'; EXCEPTION WHEN OTHERS THEN IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF; END;";
  }

  /**
   * Builds the SQL to create the migration lock table for Oracle.
   *
   * Oracle requires PL/SQL blocks to handle conditional table creation. The lock table uses numeric
   * flags and timestamps.
   *
   * @param name table name
   * @return SQL statement for creating the lock table
   */
  @Override
  public String createLockTable(String name) {
    return "BEGIN EXECUTE IMMEDIATE ' CREATE TABLE " + name
        + " ( id NUMBER PRIMARY KEY, locked NUMBER(1), granted TIMESTAMP ) '; EXCEPTION WHEN OTHERS THEN IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF; END;";
  }

  /**
   * Builds the SQL to insert the lock row for Oracle.
   *
   * This establishes the single row used for lock coordination. The lock flag is initialized to 0
   * (unlocked).
   *
   * @param name table name
   * @return SQL statement for inserting the lock row
   */
  @Override
  public String insertLock(String name) {
    return "INSERT INTO " + name + " (id, locked, granted) VALUES (1, 0, NULL);";
  }

  /**
   * Builds SQL to record a successful migration in Oracle.
   *
   * The statement updates an existing entry or inserts a new one. It uses SYSDATE to record the
   * execution time.
   *
   * @param name table name
   * @param exists whether the entry already exists
   * @return SQL statement to mark success
   */
  @Override
  public String markOkSql(String name, boolean exists) {
    return exists
        ? "UPDATE " + name
            + " SET md5sum=?, error=NULL, execution=SYSDATE WHERE name=? AND filename=?"
        : "INSERT INTO " + name
            + " (md5sum, error, name, filename, execution) VALUES (?, NULL, ?, ?, SYSDATE)";
  }

  /**
   * Builds SQL to record a failed migration in Oracle.
   *
   * The statement updates an existing entry or inserts a new one. It uses SYSDATE to record the
   * execution time.
   *
   * @param name table name
   * @param exists whether the entry already exists
   * @return SQL statement to mark failure
   */
  @Override
  public String markFailSql(String name, boolean exists) {
    return exists
        ? "UPDATE " + name + " SET md5sum=?, error=?, execution=SYSDATE WHERE name=? AND filename=?"
        : "INSERT INTO " + name
            + " (md5sum, error, name, filename, execution) VALUES (?, ?, ?, ?, SYSDATE)";
  }

  /**
   * Builds SQL to acquire the lock in Oracle.
   *
   * The lock flag is set to 1 and the grant timestamp is updated. This is called before executing
   * migrations.
   *
   * @param name table name
   * @return SQL statement to acquire the lock
   */
  @Override
  public String updateLock(String name) {
    return "UPDATE " + name + " SET locked = 1, granted = SYSDATE WHERE id = 1";
  }

}
