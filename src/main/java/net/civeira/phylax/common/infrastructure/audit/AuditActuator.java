/* @autogenerated */
package net.civeira.phylax.common.infrastructure.audit;

import java.time.ZonedDateTime;
import java.util.List;

import com.fasterxml.jackson.databind.ObjectMapper;

import io.quarkus.vertx.http.ManagementInterface;
import io.vertx.ext.web.RoutingContext;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.enterprise.event.Observes;
import lombok.RequiredArgsConstructor;

/**
 * Registers management routes to inspect audit events.
 *
 * The actuator plugs audit endpoints into the Quarkus management interface. It enables operational
 * access to recent audit records for diagnostics. This is intended for internal or admin-only
 * monitoring use cases. The handler delegates query execution to the read service.
 */
@ApplicationScoped
@RequiredArgsConstructor
public class AuditActuator {

  private final AuditReadService auditReadService;

  private final ObjectMapper mapper;

  /**
   * Registers the audit endpoint on the Quarkus management interface.
   *
   * The endpoint is exposed under the management port for operational tooling. It wires the handler
   * to fetch audit records from the read service. The management interface is provided by Quarkus
   * at startup time.
   *
   * @param management management interface to configure
   */
  public void registerManagementRoutes(@Observes ManagementInterface management) {
    management.router().get("/q/audit").handler(this::handleAuditRequest);
  }

  private void handleAuditRequest(RoutingContext ctx) {
    try {
      String entity = ctx.queryParam("entity").stream().findFirst().orElse(null);
      String entityId = ctx.queryParam("id").stream().findFirst().orElse(null);
      String user = ctx.queryParam("user").stream().findFirst().orElse(null);
      String op = ctx.queryParam("op").stream().findFirst().orElse(null);
      int limit = ctx.queryParam("limit").stream().findFirst().map(Integer::parseInt).orElse(50);
      int offset = ctx.queryParam("offset").stream().findFirst().map(Integer::parseInt).orElse(0);

      String fromStr = ctx.queryParam("from").stream().findFirst().orElse(null);
      ZonedDateTime from = fromStr != null ? ZonedDateTime.parse(fromStr) : null;
      String toStr = ctx.queryParam("to").stream().findFirst().orElse(null);
      ZonedDateTime to = fromStr != null ? ZonedDateTime.parse(toStr) : null;

      List<AuditEvent> results = auditReadService.findByFilters(entity, entity, AuditQueryFilter
          .builder().entityId(entityId).performedBy(user).operation(op).from(from).to(to).build(),
          null, limit, offset);

      ctx.response().putHeader("Content-Type", "application/json")
          .end(mapper.writeValueAsString(results));

    } catch (Exception e) {
      ctx.fail(500, e);
    }
  }
}
