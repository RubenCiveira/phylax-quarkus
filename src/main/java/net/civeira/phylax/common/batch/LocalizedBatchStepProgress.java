/* @autogenerated */
package net.civeira.phylax.common.batch;

import java.time.Instant;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import io.quarkus.runtime.annotations.RegisterForReflection;
import lombok.Builder;
import lombok.Data;
import net.civeira.phylax.common.batch.BatchStepProgress.ErrorInfo;
import net.civeira.phylax.common.batch.BatchStepProgress.Status;
import net.civeira.phylax.common.value.validation.AbstractFail.LocalizedFail;

/**
 * Localized representation of a single batch step's progress.
 *
 * It preserves timing and status metadata while translating warnings and errors. The localized view
 * is intended for UI consumption and API responses. It maps low-level error structures into
 * human-readable messages. The class is immutable and supports native reflection for serialization.
 */
@Data
@Builder
@RegisterForReflection
public class LocalizedBatchStepProgress {

  /**
   * Localized representation of validation or processing errors for a specific item.
   *
   * Each entry holds the item identifier and a list of localized failures. This structure is used
   * to render item-level error summaries in UIs. It is built from {@link ErrorInfo} using the
   * target locale.
   */
  @Data
  @Builder
  @RegisterForReflection
  public static class LocalizedErrorInfo {
    /** The identifier of the item associated with the errors or warnings. */
    private String item;
    /** List of localized validation or processing errors. */
    private List<LocalizedFail> fails;

  }

  /** The name or identifier of the batch step. */
  private final String name;

  /** Optional error message associated with the batch step. */
  private final String error;

  /** Current execution status of the batch step. */
  private final Status status;

  /** Timestamp when the step execution started. */
  private final Instant startTime;

  /** Timestamp when the step execution ended. */
  private final Instant endTime;

  /** Total number of items expected to be processed in this step. */
  private final long totalItems;

  /** Number of items that have already been processed. */
  private final long processedItems;

  /** List of successfully processed item identifiers. */
  private final List<String> oks;

  /** Localized warnings for specific items, including message and item identifiers. */
  private final List<LocalizedErrorInfo> warns;

  /** Localized errors for specific items, including message and item identifiers. */
  private final List<LocalizedErrorInfo> errors;

  /**
   * Creates a localized view of a {@link BatchStepProgress} using the given locale.
   *
   * This preserves the step status, timing, and counters while localizing errors. Warnings and
   * errors are mapped through {@link #mapMap(Map, Locale)}. Use this when returning batch progress
   * to a localized client.
   *
   * @param step original batch step progress
   * @param locale locale to use for translations
   * @return localized version of the step progress
   */
  public static LocalizedBatchStepProgress from(BatchStepProgress step, Locale locale) {
    return LocalizedBatchStepProgress.builder().name(step.getName()).error(step.getError())
        .status(step.getStatus()).startTime(step.getStartTime()).endTime(step.getEndTime())
        .totalItems(step.getTotalItems()).processedItems(step.getProcessedItems())
        .errors(mapMap(step.getErrors(), locale)).warns(mapMap(step.getWarns(), locale))
        .oks(step.getOks()).build();
  }

  /**
   * Converts an {@link ErrorInfo} instance into a localized error info object.
   *
   * The method maps each fail into a localized representation. This is used for both warnings and
   * errors in the localized view. The item key is populated by the caller when mapping the entry.
   *
   * @param info error information to localize
   * @param locale target locale
   * @return localized error info
   */
  public static LocalizedErrorInfo from(ErrorInfo info, Locale locale) {
    return LocalizedErrorInfo.builder().fails(null == info.getFails() ? null
        : info.getFails().stream().map(fail -> fail.localize(locale, true)).toList()).build();
  }

  /**
   * Converts a map of error data into localized error entries.
   *
   * Each map entry is transformed into a {@link LocalizedErrorInfo} with item id. The list is empty
   * when the input map is null. This preserves the order of the input map iteration.
   *
   * @param map map from item identifiers to error info
   * @param locale target locale for translation
   * @return list of localized error info entries
   */
  private static List<LocalizedErrorInfo> mapMap(Map<String, ErrorInfo> map, Locale locale) {
    if (null == map) {
      return List.of();
    } else {
      List<LocalizedErrorInfo> result = new ArrayList<>();
      map.entrySet().forEach(entry -> {
        LocalizedErrorInfo localize = from(entry.getValue(), locale);
        localize.setItem(entry.getKey());
        result.add(localize);
      });
      return result;
    }
  }
}
