/* @autogenerated */
package net.civeira.phylax.features.access.oauth.infrastructure.driver.impl.user;

import java.io.IOException;
import java.util.Base64;
import java.util.Locale;

import jakarta.activation.DataSource;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import net.civeira.phylax.features.access.oauth.application.usecase.MfaConfigUsecase;
import net.civeira.phylax.features.oauth.authentication.domain.AuthRequest;
import net.civeira.phylax.features.oauth.mfa.domain.PublicLoginMfaBuildResponse;
import net.civeira.phylax.features.oauth.mfa.domain.gateway.UserMfaGateway;

@Slf4j
@Transactional
@ApplicationScoped
@RequiredArgsConstructor
public class UserMfaConfigInteractor implements UserMfaGateway {
  private final MfaConfigUsecase config;

  @Override
  public PublicLoginMfaBuildResponse configurationForNewMfa(String tenant, String username,
      Locale locale) {
    AuthRequest request = AuthRequest.builder().tenant(tenant).locale(locale).build();
    boolean needsImage = requireImage(request, username);
    String imageDataUri = config.configQr(tenant, username, request.getAudiences(), locale)
        .map(ds -> toDataUri(ds)).orElse(null);
    return PublicLoginMfaBuildResponse.builder().requiresImage(needsImage).image(imageDataUri)
        .build();
  }

  @Override
  public boolean verifyOtp(String tenant, String username, String otp) {
    AuthRequest request = AuthRequest.builder().tenant(tenant).build();
    return config.validateOtpConfig(tenant, username, request.getAudiences(), otp);
  }

  @Override
  public boolean verifyNewOtp(String tenant, String username, String otp) {
    AuthRequest request = AuthRequest.builder().tenant(tenant).build();
    return config.validateOtpConfig(tenant, username, request.getAudiences(), otp);
  }

  @Override
  public void storeSeed(String tenant, String username, String seed) {
    // Legacy flow stores the seed during OTP validation.
  }

  private boolean requireImage(AuthRequest request, String username) {
    return true;
  }

  private String toDataUri(DataSource ds) {
    try {
      byte[] bytes = ds.getInputStream().readAllBytes();
      return "data:" + ds.getContentType() + ";base64," + Base64.getEncoder().encodeToString(bytes);
    } catch (IOException e) {
      log.error("Error reading QR image", e);
      return null;
    }
  }
}
