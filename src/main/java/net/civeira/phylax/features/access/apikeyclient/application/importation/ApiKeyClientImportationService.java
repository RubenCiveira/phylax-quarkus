package net.civeira.phylax.features.access.apikeyclient.application.importation;

import java.util.Map;
import java.util.Optional;

import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.value.validation.ConstraintFail;
import net.civeira.phylax.common.value.validation.ConstraintFailList;
import net.civeira.phylax.features.access.apikeyclient.domain.ApiKeyClient;
import net.civeira.phylax.features.access.apikeyclient.domain.ApiKeyClientChangeSet;
import net.civeira.phylax.features.access.apikeyclient.domain.gateway.ApiKeyClientFilter;
import net.civeira.phylax.features.access.apikeyclient.domain.gateway.ApiKeyClientWriteRepositoryGateway;
import net.civeira.phylax.features.access.apikeyclient.domain.valueobject.EnabledVO;

@RequiredArgsConstructor
public class ApiKeyClientImportationService {

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final ApiKeyClientWriteRepositoryGateway repository;

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @return
   */
  public ApiKeyClientImportationResult load(final Map<String, String> row) {
    ConstraintFailList fails = new ConstraintFailList();
    String uid = row.get("uid");
    if (null == uid) {
      fails.add(new ConstraintFail("NOT_NULL", "uid", null));
    }
    boolean exists = false;
    ApiKeyClient entity = null;
    if (!fails.isEmpty()) {
      Optional<ApiKeyClient> existing =
          repository.findForUpdate(ApiKeyClientFilter.builder().uid(uid).build());
      ApiKeyClientChangeSet change = toChangeSet(row, fails);
      if (existing.isPresent()) {
        entity = existing.get().update(change);
        exists = true;
      } else {
        entity = ApiKeyClient.create(change.newUid());
      }
    }
    return fails.isEmpty() ? new ApiKeyClientImportationResult(entity, exists)
        : new ApiKeyClientImportationResult(fails);
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param fails
   * @return
   */
  public ApiKeyClientChangeSet toChangeSet(final Map<String, String> row,
      final ConstraintFailList fails) {
    ApiKeyClientChangeSet change = new ApiKeyClientChangeSet();
    change = readCode(change, row, fails);
    change = readKey(change, row, fails);
    change = readEnabled(change, row, fails);
    change = readScopes(change, row, fails);
    return change;
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private ApiKeyClientChangeSet readCode(final ApiKeyClientChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String code = row.get("code");
    if (code != null) {
      return change.code(code);
    } else {
      return change.unsetCode();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private ApiKeyClientChangeSet readEnabled(final ApiKeyClientChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String enabled = row.get("enabled");
    if (enabled != null) {
      return change.enabled(EnabledVO.tryFromString(enabled, fails));
    } else {
      return change.unsetEnabled();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private ApiKeyClientChangeSet readKey(final ApiKeyClientChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String key = row.get("key");
    if (key != null) {
      return change.key(key);
    } else {
      return change.unsetKey();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private ApiKeyClientChangeSet readScopes(final ApiKeyClientChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String scopes = row.get("scopes");
    if (scopes != null) {
      return change.scopes(scopes);
    } else {
      return change.unsetScopes();
    }
  }
}
