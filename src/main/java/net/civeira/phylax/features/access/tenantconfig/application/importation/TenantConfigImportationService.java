package net.civeira.phylax.features.access.tenantconfig.application.importation;

import java.util.Map;
import java.util.Optional;

import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.value.validation.ConstraintFail;
import net.civeira.phylax.common.value.validation.ConstraintFailList;
import net.civeira.phylax.features.access.tenant.domain.Tenant;
import net.civeira.phylax.features.access.tenant.domain.TenantChangeSet;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantFilter;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantReadRepositoryGateway;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantWriteRepositoryGateway;
import net.civeira.phylax.features.access.tenantconfig.domain.TenantConfig;
import net.civeira.phylax.features.access.tenantconfig.domain.TenantConfigChangeSet;
import net.civeira.phylax.features.access.tenantconfig.domain.gateway.TenantConfigFilter;
import net.civeira.phylax.features.access.tenantconfig.domain.gateway.TenantConfigWriteRepositoryGateway;
import net.civeira.phylax.features.access.tenantconfig.domain.valueobject.AllowRecoverPassVO;
import net.civeira.phylax.features.access.tenantconfig.domain.valueobject.AllowRegisterVO;
import net.civeira.phylax.features.access.tenantconfig.domain.valueobject.EnableRegisterUsersVO;
import net.civeira.phylax.features.access.tenantconfig.domain.valueobject.ForceMfaVO;

@RequiredArgsConstructor
public class TenantConfigImportationService {

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantConfigWriteRepositoryGateway repository;

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantReadRepositoryGateway tenantReadRepository;

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantWriteRepositoryGateway tenantWriteRepository;

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @return
   */
  public TenantConfigImportationResult load(final Map<String, String> row) {
    return load(row, TenantConfigImportationRelatedResolver.builder().build());
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param resolver
   * @return
   */
  public TenantConfigImportationResult load(final Map<String, String> row,
      final TenantConfigImportationRelatedResolver resolver) {
    ConstraintFailList fails = new ConstraintFailList();
    String uid = row.get("uid");
    if (null == uid) {
      fails.add(new ConstraintFail("NOT_NULL", "uid", null));
    }
    boolean exists = false;
    TenantConfig entity = null;
    if (!fails.isEmpty()) {
      Optional<TenantConfig> existing =
          repository.findForUpdate(TenantConfigFilter.builder().uid(uid).build());
      TenantConfigChangeSet change = toChangeSet(row, fails, resolver);
      if (existing.isPresent()) {
        entity = existing.get().update(change);
        exists = true;
      } else {
        entity = TenantConfig.create(change.newUid());
      }
    }
    return fails.isEmpty() ? new TenantConfigImportationResult(entity, exists)
        : new TenantConfigImportationResult(fails);
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  public TenantConfigChangeSet toChangeSet(final Map<String, String> row,
      final ConstraintFailList fails, final TenantConfigImportationRelatedResolver resolver) {
    TenantConfigChangeSet change = new TenantConfigChangeSet();
    change = readTenant(change, row, fails, resolver);
    change = readInnerLabel(change, row, fails, resolver);
    change = readForceMfa(change, row, fails, resolver);
    change = readAllowRegister(change, row, fails, resolver);
    change = readEnableRegisterUsers(change, row, fails, resolver);
    change = readWellcomeEmail(change, row, fails, resolver);
    change = readRegisterdEmail(change, row, fails, resolver);
    change = readDisabledUserEmail(change, row, fails, resolver);
    change = readEnabledUserEmail(change, row, fails, resolver);
    change = readAllowRecoverPass(change, row, fails, resolver);
    change = readRecoverPassEmail(change, row, fails, resolver);
    return change;
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantConfigChangeSet readAllowRecoverPass(final TenantConfigChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantConfigImportationRelatedResolver resolver) {
    String allowRecoverPass = row.get("allowRecoverPass");
    if (allowRecoverPass != null) {
      return change.allowRecoverPass(AllowRecoverPassVO.tryFromString(allowRecoverPass, fails));
    } else {
      return change.unsetAllowRecoverPass();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantConfigChangeSet readAllowRegister(final TenantConfigChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantConfigImportationRelatedResolver resolver) {
    String allowRegister = row.get("allowRegister");
    if (allowRegister != null) {
      return change.allowRegister(AllowRegisterVO.tryFromString(allowRegister, fails));
    } else {
      return change.unsetAllowRegister();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantConfigChangeSet readDisabledUserEmail(final TenantConfigChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantConfigImportationRelatedResolver resolver) {
    String disabledUserEmail = row.get("disabledUserEmail");
    if (disabledUserEmail != null) {
      return change.disabledUserEmail(disabledUserEmail);
    } else {
      return change.unsetDisabledUserEmail();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantConfigChangeSet readEnableRegisterUsers(final TenantConfigChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantConfigImportationRelatedResolver resolver) {
    String enableRegisterUsers = row.get("enableRegisterUsers");
    if (enableRegisterUsers != null) {
      return change
          .enableRegisterUsers(EnableRegisterUsersVO.tryFromString(enableRegisterUsers, fails));
    } else {
      return change.unsetEnableRegisterUsers();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantConfigChangeSet readEnabledUserEmail(final TenantConfigChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantConfigImportationRelatedResolver resolver) {
    String enabledUserEmail = row.get("enabledUserEmail");
    if (enabledUserEmail != null) {
      return change.enabledUserEmail(enabledUserEmail);
    } else {
      return change.unsetEnabledUserEmail();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantConfigChangeSet readForceMfa(final TenantConfigChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantConfigImportationRelatedResolver resolver) {
    String forceMfa = row.get("forceMfa");
    if (forceMfa != null) {
      return change.forceMfa(ForceMfaVO.tryFromString(forceMfa, fails));
    } else {
      return change.unsetForceMfa();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantConfigChangeSet readInnerLabel(final TenantConfigChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantConfigImportationRelatedResolver resolver) {
    String innerLabel = row.get("innerLabel");
    if (innerLabel != null) {
      return change.innerLabel(innerLabel);
    } else {
      return change.unsetInnerLabel();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantConfigChangeSet readRecoverPassEmail(final TenantConfigChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantConfigImportationRelatedResolver resolver) {
    String recoverPassEmail = row.get("recoverPassEmail");
    if (recoverPassEmail != null) {
      return change.recoverPassEmail(recoverPassEmail);
    } else {
      return change.unsetRecoverPassEmail();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantConfigChangeSet readRegisterdEmail(final TenantConfigChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantConfigImportationRelatedResolver resolver) {
    String registerdEmail = row.get("registerdEmail");
    if (registerdEmail != null) {
      return change.registerdEmail(registerdEmail);
    } else {
      return change.unsetRegisterdEmail();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantConfigChangeSet readTenant(final TenantConfigChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantConfigImportationRelatedResolver resolver) {
    String tenant = row.get("tenant");
    if (tenant != null) {
      Optional<Tenant> existing =
          tenantReadRepository.find(TenantFilter.builder().name(tenant).build());
      if (existing.isPresent()) {
        return change.tenant(existing.get());
      } else if (resolver.isCreateMissingTenant()) {
        TenantChangeSet childChanges = new TenantChangeSet().newUid();
        Tenant entity = (null == resolver.getMissingTenantFactory()) ? Tenant.create(childChanges)
            : resolver.getMissingTenantFactory().apply(childChanges);
        return change.tenant(tenantWriteRepository.create(entity));
      } else {
        fails.add(new ConstraintFail("NOT_FOUND", "tenant", tenant));
        return change;
      }
    } else {
      return change.unsetTenant();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantConfigChangeSet readWellcomeEmail(final TenantConfigChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantConfigImportationRelatedResolver resolver) {
    String wellcomeEmail = row.get("wellcomeEmail");
    if (wellcomeEmail != null) {
      return change.wellcomeEmail(wellcomeEmail);
    } else {
      return change.unsetWellcomeEmail();
    }
  }
}
