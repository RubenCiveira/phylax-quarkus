package net.civeira.phylax.features.access.tenantconfig.infrastructure.driver.rest;

import java.time.LocalDate;
import java.time.ZoneId;
import java.util.List;

import jakarta.enterprise.context.ApplicationScoped;
import jakarta.ws.rs.core.Response;
import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.infrastructure.CurrentRequest;
import net.civeira.phylax.common.infrastructure.audit.AuditEvent;
import net.civeira.phylax.common.infrastructure.audit.AuditQueryFilter;
import net.civeira.phylax.common.infrastructure.audit.AuditReadService;
import net.civeira.phylax.generated.openapi.api.TenantConfigAuditApi;
import net.civeira.phylax.generated.openapi.model.AuditEventDto;

@RequiredArgsConstructor
@ApplicationScoped
public class TenantConfigAuditController implements TenantConfigAuditApi {

  /**
   * @autogenerated AuditControllerGenerator
   */
  private final CurrentRequest currentRequest;

  /**
   * @autogenerated AuditControllerGenerator
   */
  private final AuditReadService reader;

  /**
   * @autogenerated AuditControllerGenerator
   * @param actor
   * @param from
   * @param to
   * @return
   */
  @Override
  public Response tenantConfigApiActorAudit(final String actor, final LocalDate from,
      final LocalDate to) {
    String self = currentRequest.getActor().getName().orElse("-");
    List<AuditEvent> events = reader.findByFilters("access_tenant_config_audit", "tenantConfig",
        AuditQueryFilter.builder().performedBy(self).from(from.atStartOfDay(ZoneId.systemDefault()))
            .to(to.atStartOfDay(ZoneId.systemDefault())).build(),
        tenant(), 0, 1000);
    return Response.ok(events.stream().map(this::map).toList()).build();
  }

  /**
   * @autogenerated AuditControllerGenerator
   * @param uid
   * @return
   */
  @Override
  public Response tenantConfigApiEntityAudit(final String uid) {
    String self = currentRequest.getActor().getName().orElse("-");
    List<AuditEvent> events = reader.findByFilters("access_tenant_config_audit", "tenantConfig",
        AuditQueryFilter.builder().entityId(uid).performedBy(self).build(), tenant(), 0, 1000);
    return Response.ok(events.stream().map(this::map).toList()).build();
  }

  /**
   * @autogenerated AuditControllerGenerator
   * @param event
   * @return
   */
  private AuditEventDto map(final AuditEvent event) {
    return new AuditEventDto().operation(event.getOperation()).usecase(event.getUsecase())
        .entityType("tenantConfig").entityType(event.getEntityType()).entityId(event.getEntityId())
        .oldValues(event.getOldValue()).newValues(event.getNewValue())
        .performedBy(event.getPerformedBy()).tenant(event.getTenant())
        .timestamp(event.getTimestamp().toOffsetDateTime()).sourceRequest(event.getSourceRequest())
        .remoteAddress(event.getRemoteAddress()).remoteApplication(event.getRemoteApplication())
        .remoteDevice(event.getRemoteDevice()).claims(event.getClaims());
  }

  /**
   * @autogenerated AuditControllerGenerator
   * @return
   */
  private String tenant() {
    return null;
  }
}
