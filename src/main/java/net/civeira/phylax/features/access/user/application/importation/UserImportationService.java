package net.civeira.phylax.features.access.user.application.importation;

import java.util.Map;
import java.util.Optional;

import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.value.validation.ConstraintFail;
import net.civeira.phylax.common.value.validation.ConstraintFailList;
import net.civeira.phylax.features.access.tenant.domain.Tenant;
import net.civeira.phylax.features.access.tenant.domain.TenantChangeSet;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantFilter;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantReadRepositoryGateway;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantWriteRepositoryGateway;
import net.civeira.phylax.features.access.user.domain.User;
import net.civeira.phylax.features.access.user.domain.UserChangeSet;
import net.civeira.phylax.features.access.user.domain.gateway.UserFilter;
import net.civeira.phylax.features.access.user.domain.gateway.UserWriteRepositoryGateway;
import net.civeira.phylax.features.access.user.domain.valueobject.ApproveVO;
import net.civeira.phylax.features.access.user.domain.valueobject.BlockedUntilVO;
import net.civeira.phylax.features.access.user.domain.valueobject.EnabledVO;
import net.civeira.phylax.features.access.user.domain.valueobject.TemporalPasswordVO;
import net.civeira.phylax.features.access.user.domain.valueobject.UseSecondFactorsVO;
import net.civeira.phylax.features.access.user.domain.valueobject.WellcomeAtVO;

@RequiredArgsConstructor
public class UserImportationService {

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final UserWriteRepositoryGateway repository;

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantReadRepositoryGateway tenantReadRepository;

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantWriteRepositoryGateway tenantWriteRepository;

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @return
   */
  public UserImportationResult load(final Map<String, String> row) {
    return load(row, UserImportationRelatedResolver.builder().build());
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param resolver
   * @return
   */
  public UserImportationResult load(final Map<String, String> row,
      final UserImportationRelatedResolver resolver) {
    ConstraintFailList fails = new ConstraintFailList();
    String name = row.get("name");
    if (null == name) {
      fails.add(new ConstraintFail("NOT_NULL", "name", null));
    }
    boolean exists = false;
    User entity = null;
    if (!fails.isEmpty()) {
      Optional<User> existing = repository.findForUpdate(UserFilter.builder().name(name).build());
      UserChangeSet change = toChangeSet(row, fails, resolver);
      if (existing.isPresent()) {
        entity = existing.get().update(change);
        exists = true;
      } else {
        entity = User.create(change.newUid());
      }
    }
    return fails.isEmpty() ? new UserImportationResult(entity, exists)
        : new UserImportationResult(fails);
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  public UserChangeSet toChangeSet(final Map<String, String> row, final ConstraintFailList fails,
      final UserImportationRelatedResolver resolver) {
    UserChangeSet change = new UserChangeSet();
    change = readTenant(change, row, fails, resolver);
    change = readName(change, row, fails, resolver);
    change = readPassword(change, row, fails, resolver);
    change = readEmail(change, row, fails, resolver);
    change = readWellcomeAt(change, row, fails, resolver);
    change = readEnabled(change, row, fails, resolver);
    change = readApprove(change, row, fails, resolver);
    change = readTemporalPassword(change, row, fails, resolver);
    change = readUseSecondFactors(change, row, fails, resolver);
    change = readSecondFactorSeed(change, row, fails, resolver);
    change = readBlockedUntil(change, row, fails, resolver);
    change = readProvider(change, row, fails, resolver);
    return change;
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readApprove(final UserChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails, final UserImportationRelatedResolver resolver) {
    String approve = row.get("approve");
    if (approve != null) {
      return change.approve(ApproveVO.tryFromString(approve, fails));
    } else {
      return change.unsetApprove();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readBlockedUntil(final UserChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails, final UserImportationRelatedResolver resolver) {
    String blockedUntil = row.get("blockedUntil");
    if (blockedUntil != null) {
      return change.blockedUntil(BlockedUntilVO.tryFromString(blockedUntil, fails));
    } else {
      return change.unsetBlockedUntil();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readEmail(final UserChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails, final UserImportationRelatedResolver resolver) {
    String email = row.get("email");
    if (email != null) {
      return change.email(email);
    } else {
      return change.unsetEmail();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readEnabled(final UserChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails, final UserImportationRelatedResolver resolver) {
    String enabled = row.get("enabled");
    if (enabled != null) {
      return change.enabled(EnabledVO.tryFromString(enabled, fails));
    } else {
      return change.unsetEnabled();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readName(final UserChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails, final UserImportationRelatedResolver resolver) {
    String name = row.get("name");
    if (name != null) {
      return change.name(name);
    } else {
      return change.unsetName();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readPassword(final UserChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails, final UserImportationRelatedResolver resolver) {
    String password = row.get("password");
    if (password != null) {
      return change.passwordPlain(password);
    } else {
      return change.unsetPassword();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readProvider(final UserChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails, final UserImportationRelatedResolver resolver) {
    String provider = row.get("provider");
    if (provider != null) {
      return change.provider(provider);
    } else {
      return change.unsetProvider();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readSecondFactorSeed(final UserChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final UserImportationRelatedResolver resolver) {
    String secondFactorSeed = row.get("secondFactorSeed");
    if (secondFactorSeed != null) {
      return change.secondFactorSeedPlain(secondFactorSeed);
    } else {
      return change.unsetSecondFactorSeed();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readTemporalPassword(final UserChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final UserImportationRelatedResolver resolver) {
    String temporalPassword = row.get("temporalPassword");
    if (temporalPassword != null) {
      return change.temporalPassword(TemporalPasswordVO.tryFromString(temporalPassword, fails));
    } else {
      return change.unsetTemporalPassword();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readTenant(final UserChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails, final UserImportationRelatedResolver resolver) {
    String tenant = row.get("tenant");
    if (tenant != null) {
      Optional<Tenant> existing =
          tenantReadRepository.find(TenantFilter.builder().name(tenant).build());
      if (existing.isPresent()) {
        return change.tenant(existing.get());
      } else if (resolver.isCreateMissingTenant()) {
        TenantChangeSet childChanges = new TenantChangeSet().newUid();
        Tenant entity = (null == resolver.getMissingTenantFactory()) ? Tenant.create(childChanges)
            : resolver.getMissingTenantFactory().apply(childChanges);
        return change.tenant(tenantWriteRepository.create(entity));
      } else {
        fails.add(new ConstraintFail("NOT_FOUND", "tenant", tenant));
        return change;
      }
    } else {
      return change.unsetTenant();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readUseSecondFactors(final UserChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final UserImportationRelatedResolver resolver) {
    String useSecondFactors = row.get("useSecondFactors");
    if (useSecondFactors != null) {
      return change.useSecondFactors(UseSecondFactorsVO.tryFromString(useSecondFactors, fails));
    } else {
      return change.unsetUseSecondFactors();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private UserChangeSet readWellcomeAt(final UserChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails, final UserImportationRelatedResolver resolver) {
    String wellcomeAt = row.get("wellcomeAt");
    if (wellcomeAt != null) {
      return change.wellcomeAt(WellcomeAtVO.tryFromString(wellcomeAt, fails));
    } else {
      return change.unsetWellcomeAt();
    }
  }
}
