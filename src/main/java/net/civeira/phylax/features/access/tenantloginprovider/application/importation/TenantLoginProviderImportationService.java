package net.civeira.phylax.features.access.tenantloginprovider.application.importation;

import java.util.Map;
import java.util.Optional;

import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.value.validation.ConstraintFail;
import net.civeira.phylax.common.value.validation.ConstraintFailList;
import net.civeira.phylax.features.access.tenant.domain.Tenant;
import net.civeira.phylax.features.access.tenant.domain.TenantChangeSet;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantFilter;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantReadRepositoryGateway;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantWriteRepositoryGateway;
import net.civeira.phylax.features.access.tenantloginprovider.domain.TenantLoginProvider;
import net.civeira.phylax.features.access.tenantloginprovider.domain.TenantLoginProviderChangeSet;
import net.civeira.phylax.features.access.tenantloginprovider.domain.gateway.TenantLoginProviderFilter;
import net.civeira.phylax.features.access.tenantloginprovider.domain.gateway.TenantLoginProviderWriteRepositoryGateway;
import net.civeira.phylax.features.access.tenantloginprovider.domain.valueobject.DirectAccessVO;
import net.civeira.phylax.features.access.tenantloginprovider.domain.valueobject.DisabledVO;
import net.civeira.phylax.features.access.tenantloginprovider.domain.valueobject.SourceVO;
import net.civeira.phylax.features.access.tenantloginprovider.domain.valueobject.UsersEnabledByDefaultVO;

@RequiredArgsConstructor
public class TenantLoginProviderImportationService {

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantLoginProviderWriteRepositoryGateway repository;

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantReadRepositoryGateway tenantReadRepository;

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantWriteRepositoryGateway tenantWriteRepository;

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @return
   */
  public TenantLoginProviderImportationResult load(final Map<String, String> row) {
    return load(row, TenantLoginProviderImportationRelatedResolver.builder().build());
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param resolver
   * @return
   */
  public TenantLoginProviderImportationResult load(final Map<String, String> row,
      final TenantLoginProviderImportationRelatedResolver resolver) {
    ConstraintFailList fails = new ConstraintFailList();
    String name = row.get("name");
    if (null == name) {
      fails.add(new ConstraintFail("NOT_NULL", "name", null));
    }
    boolean exists = false;
    TenantLoginProvider entity = null;
    if (!fails.isEmpty()) {
      Optional<TenantLoginProvider> existing =
          repository.findForUpdate(TenantLoginProviderFilter.builder().name(name).build());
      TenantLoginProviderChangeSet change = toChangeSet(row, fails, resolver);
      if (existing.isPresent()) {
        entity = existing.get().update(change);
        exists = true;
      } else {
        entity = TenantLoginProvider.create(change.newUid());
      }
    }
    return fails.isEmpty() ? new TenantLoginProviderImportationResult(entity, exists)
        : new TenantLoginProviderImportationResult(fails);
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  public TenantLoginProviderChangeSet toChangeSet(final Map<String, String> row,
      final ConstraintFailList fails,
      final TenantLoginProviderImportationRelatedResolver resolver) {
    TenantLoginProviderChangeSet change = new TenantLoginProviderChangeSet();
    change = readTenant(change, row, fails, resolver);
    change = readName(change, row, fails, resolver);
    change = readSource(change, row, fails, resolver);
    change = readDisabled(change, row, fails, resolver);
    change = readDirectAccess(change, row, fails, resolver);
    change = readPublicKey(change, row, fails, resolver);
    change = readPrivateKey(change, row, fails, resolver);
    change = readCertificate(change, row, fails, resolver);
    change = readUsersEnabledByDefault(change, row, fails, resolver);
    return change;
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantLoginProviderChangeSet readCertificate(final TenantLoginProviderChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantLoginProviderImportationRelatedResolver resolver) {
    String certificate = row.get("certificate");
    if (certificate != null) {
      return change.certificate(certificate);
    } else {
      return change.unsetCertificate();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantLoginProviderChangeSet readDirectAccess(final TenantLoginProviderChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantLoginProviderImportationRelatedResolver resolver) {
    String directAccess = row.get("directAccess");
    if (directAccess != null) {
      return change.directAccess(DirectAccessVO.tryFromString(directAccess, fails));
    } else {
      return change.unsetDirectAccess();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantLoginProviderChangeSet readDisabled(final TenantLoginProviderChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantLoginProviderImportationRelatedResolver resolver) {
    String disabled = row.get("disabled");
    if (disabled != null) {
      return change.disabled(DisabledVO.tryFromString(disabled, fails));
    } else {
      return change.unsetDisabled();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantLoginProviderChangeSet readName(final TenantLoginProviderChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantLoginProviderImportationRelatedResolver resolver) {
    String name = row.get("name");
    if (name != null) {
      return change.name(name);
    } else {
      return change.unsetName();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantLoginProviderChangeSet readPrivateKey(final TenantLoginProviderChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantLoginProviderImportationRelatedResolver resolver) {
    String privateKey = row.get("privateKey");
    if (privateKey != null) {
      return change.privateKey(privateKey);
    } else {
      return change.unsetPrivateKey();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantLoginProviderChangeSet readPublicKey(final TenantLoginProviderChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantLoginProviderImportationRelatedResolver resolver) {
    String publicKey = row.get("publicKey");
    if (publicKey != null) {
      return change.publicKey(publicKey);
    } else {
      return change.unsetPublicKey();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantLoginProviderChangeSet readSource(final TenantLoginProviderChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantLoginProviderImportationRelatedResolver resolver) {
    String source = row.get("source");
    if (source != null) {
      return change.source(SourceVO.tryFromString(source, fails));
    } else {
      return change.unsetSource();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantLoginProviderChangeSet readTenant(final TenantLoginProviderChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantLoginProviderImportationRelatedResolver resolver) {
    String tenant = row.get("tenant");
    if (tenant != null) {
      Optional<Tenant> existing =
          tenantReadRepository.find(TenantFilter.builder().name(tenant).build());
      if (existing.isPresent()) {
        return change.tenant(existing.get());
      } else if (resolver.isCreateMissingTenant()) {
        TenantChangeSet childChanges = new TenantChangeSet().newUid();
        Tenant entity = (null == resolver.getMissingTenantFactory()) ? Tenant.create(childChanges)
            : resolver.getMissingTenantFactory().apply(childChanges);
        return change.tenant(tenantWriteRepository.create(entity));
      } else {
        fails.add(new ConstraintFail("NOT_FOUND", "tenant", tenant));
        return change;
      }
    } else {
      return change.unsetTenant();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantLoginProviderChangeSet readUsersEnabledByDefault(
      final TenantLoginProviderChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails,
      final TenantLoginProviderImportationRelatedResolver resolver) {
    String usersEnabledByDefault = row.get("usersEnabledByDefault");
    if (usersEnabledByDefault != null) {
      return change.usersEnabledByDefault(
          UsersEnabledByDefaultVO.tryFromString(usersEnabledByDefault, fails));
    } else {
      return change.unsetUsersEnabledByDefault();
    }
  }
}
