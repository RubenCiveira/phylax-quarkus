package net.civeira.phylax.features.access.role.application.importation;

import java.util.Map;
import java.util.Optional;

import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.value.validation.ConstraintFail;
import net.civeira.phylax.common.value.validation.ConstraintFailList;
import net.civeira.phylax.features.access.relyingparty.domain.RelyingParty;
import net.civeira.phylax.features.access.relyingparty.domain.RelyingPartyChangeSet;
import net.civeira.phylax.features.access.relyingparty.domain.gateway.RelyingPartyFilter;
import net.civeira.phylax.features.access.relyingparty.domain.gateway.RelyingPartyReadRepositoryGateway;
import net.civeira.phylax.features.access.relyingparty.domain.gateway.RelyingPartyWriteRepositoryGateway;
import net.civeira.phylax.features.access.role.domain.Role;
import net.civeira.phylax.features.access.role.domain.RoleChangeSet;
import net.civeira.phylax.features.access.role.domain.gateway.RoleFilter;
import net.civeira.phylax.features.access.role.domain.gateway.RoleWriteRepositoryGateway;

@RequiredArgsConstructor
public class RoleImportationService {

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final RelyingPartyReadRepositoryGateway relyingPartyReadRepository;

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final RelyingPartyWriteRepositoryGateway relyingPartyWriteRepository;

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final RoleWriteRepositoryGateway repository;

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @return
   */
  public RoleImportationResult load(final Map<String, String> row) {
    return load(row, RoleImportationRelatedResolver.builder().build());
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param resolver
   * @return
   */
  public RoleImportationResult load(final Map<String, String> row,
      final RoleImportationRelatedResolver resolver) {
    ConstraintFailList fails = new ConstraintFailList();
    String name = row.get("name");
    if (null == name) {
      fails.add(new ConstraintFail("NOT_NULL", "name", null));
    }
    boolean exists = false;
    Role entity = null;
    if (!fails.isEmpty()) {
      Optional<Role> existing = repository.findForUpdate(RoleFilter.builder().name(name).build());
      RoleChangeSet change = toChangeSet(row, fails, resolver);
      if (existing.isPresent()) {
        entity = existing.get().update(change);
        exists = true;
      } else {
        entity = Role.create(change.newUid());
      }
    }
    return fails.isEmpty() ? new RoleImportationResult(entity, exists)
        : new RoleImportationResult(fails);
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  public RoleChangeSet toChangeSet(final Map<String, String> row, final ConstraintFailList fails,
      final RoleImportationRelatedResolver resolver) {
    RoleChangeSet change = new RoleChangeSet();
    change = readName(change, row, fails, resolver);
    change = readRelyingParty(change, row, fails, resolver);
    return change;
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private RoleChangeSet readName(final RoleChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails, final RoleImportationRelatedResolver resolver) {
    String name = row.get("name");
    if (name != null) {
      return change.name(name);
    } else {
      return change.unsetName();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private RoleChangeSet readRelyingParty(final RoleChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails, final RoleImportationRelatedResolver resolver) {
    String relyingParty = row.get("relyingParty");
    if (relyingParty != null) {
      Optional<RelyingParty> existing =
          relyingPartyReadRepository.find(RelyingPartyFilter.builder().code(relyingParty).build());
      if (existing.isPresent()) {
        return change.relyingParty(existing.get());
      } else if (resolver.isCreateMissingRelyingParty()) {
        RelyingPartyChangeSet childChanges = new RelyingPartyChangeSet().newUid();
        RelyingParty entity =
            (null == resolver.getMissingRelyingPartyFactory()) ? RelyingParty.create(childChanges)
                : resolver.getMissingRelyingPartyFactory().apply(childChanges);
        return change.relyingParty(relyingPartyWriteRepository.create(entity));
      } else {
        fails.add(new ConstraintFail("NOT_FOUND", "relyingParty", relyingParty));
        return change;
      }
    } else {
      return change.unsetRelyingParty();
    }
  }
}
