package net.civeira.phylax.features.access.tenantloginprovider.infrastructure.driver.rest;

import java.io.InputStream;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

import io.opentelemetry.api.trace.Span;
import io.opentelemetry.api.trace.SpanKind;
import io.opentelemetry.api.trace.Tracer;
import io.opentelemetry.context.Context;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.ws.rs.core.Response;
import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.infrastructure.CurrentRequest;
import net.civeira.phylax.common.infrastructure.store.BinaryContent;
import net.civeira.phylax.features.access.tenantloginprovider.application.usecase.metadataretrieve.TenantLoginProviderMetadataRetrieveUsecase;
import net.civeira.phylax.features.access.tenantloginprovider.application.usecase.metadataupload.TenantLoginProviderMetadataTemporalUploadUsecase;
import net.civeira.phylax.features.access.tenantloginprovider.domain.TenantLoginProviderReference;

@RequiredArgsConstructor
@ApplicationScoped
public class TenantLoginProviderMetadataUploadController {

  /**
   * @autogenerated FileControllerGenerator
   */
  private final CurrentRequest currentRequest;

  /**
   * @autogenerated FileControllerGenerator
   */
  private final TenantLoginProviderMetadataRetrieveUsecase retrieveMetadataUploadUsecase;

  /**
   * @autogenerated FileControllerGenerator
   */
  private final TenantLoginProviderMetadataTemporalUploadUsecase tempMetadataUploadUsecase;

  /**
   * @autogenerated FileControllerGenerator
   */
  private final Tracer tracer;

  /**
   * @autogenerated FileControllerGenerator
   * @param uid
   * @return
   */
  public Response tenantLoginProviderApiRetrieveMetadata(final String uid) {
    Span span = tracer
        .spanBuilder("Api to retrieve uploaded metadata an entity of tenant login provider")
        .setParent(Context.current().with(Span.current())).setSpanKind(SpanKind.SERVER).startSpan();
    try {
      span.setAttribute("ref", uid);
      BinaryContent stream = retrieveMetadataUploadUsecase.read(currentRequest.interaction(),
          TenantLoginProviderReference.of(uid));
      String encodedFilename = URLEncoder.encode(stream.getName(), StandardCharsets.UTF_8);
      return Response.ok(stream.getInputStream()).header("Content-type", stream.getContentType())
          .header("Content-Disposition", "attachment; filename*=UTF-8''" + encodedFilename).build();
    } catch (RuntimeException ex) {
      span.setAttribute("error", true);
      span.recordException(ex);
      throw ex;
    } finally {
      span.end();
    }
  }

  /**
   * @autogenerated FileControllerGenerator
   * @param temp
   * @return
   */
  public Response tenantLoginProviderApiRetrieveTempUploadMetadata(final String temp) {
    Span span = tracer
        .spanBuilder(
            "Api to retrieve temporal uploaded metadata an entity of tenant login provider")
        .setParent(Context.current().with(Span.current())).setSpanKind(SpanKind.SERVER).startSpan();
    try {
      span.setAttribute("temp-id", temp);
      BinaryContent stream = tempMetadataUploadUsecase.read(currentRequest.interaction(), temp);
      return Response.ok(stream.getInputStream()).build();
    } catch (RuntimeException ex) {
      span.setAttribute("error", true);
      span.recordException(ex);
      throw ex;
    } finally {
      span.end();
    }
  }

  /**
   * @autogenerated FileControllerGenerator
   * @param file
   * @param fileName
   * @param fileType
   * @return
   */
  public Response tenantLoginProviderApiUploadTempUploadMetadata(final InputStream file,
      final String fileName, final String fileType) {
    Span span = tracer.spanBuilder("Api to upload metadata an entity of tenant login provider")
        .setParent(Context.current().with(Span.current())).setSpanKind(SpanKind.SERVER).startSpan();
    try {
      String key = tempMetadataUploadUsecase.upload(currentRequest.interaction(),
          BinaryContent.builder().name(fileName).contentType(fileType)
              .lastModification(System.currentTimeMillis()).inputStream(file).build());
      return Response.ok(currentRequest.getPublicHost()
          + "/api/access/login-providers/-/temp-metadata?temp=" + key).build();
    } catch (RuntimeException ex) {
      span.setAttribute("error", true);
      span.recordException(ex);
      throw ex;
    } finally {
      span.end();
    }
  }
}
