package net.civeira.phylax.features.access.tenanttermsofuse.infrastructure.driver.rest;

import java.io.InputStream;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

import io.opentelemetry.api.trace.Span;
import io.opentelemetry.api.trace.SpanKind;
import io.opentelemetry.api.trace.Tracer;
import io.opentelemetry.context.Context;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.ws.rs.core.Response;
import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.infrastructure.CurrentRequest;
import net.civeira.phylax.common.infrastructure.store.BinaryContent;
import net.civeira.phylax.features.access.tenanttermsofuse.application.usecase.attachedretrieve.TenantTermsOfUseAttachedRetrieveUsecase;
import net.civeira.phylax.features.access.tenanttermsofuse.application.usecase.attachedupload.TenantTermsOfUseAttachedTemporalUploadUsecase;
import net.civeira.phylax.features.access.tenanttermsofuse.domain.TenantTermsOfUseReference;

@RequiredArgsConstructor
@ApplicationScoped
public class TenantTermsOfUseAttachedUploadController {

  /**
   * @autogenerated FileControllerGenerator
   */
  private final CurrentRequest currentRequest;

  /**
   * @autogenerated FileControllerGenerator
   */
  private final TenantTermsOfUseAttachedRetrieveUsecase retrieveAttachedUploadUsecase;

  /**
   * @autogenerated FileControllerGenerator
   */
  private final TenantTermsOfUseAttachedTemporalUploadUsecase tempAttachedUploadUsecase;

  /**
   * @autogenerated FileControllerGenerator
   */
  private final Tracer tracer;

  /**
   * @autogenerated FileControllerGenerator
   * @param uid
   * @return
   */
  public Response tenantTermsOfUseApiRetrieveAttached(final String uid) {
    Span span = tracer
        .spanBuilder("Api to retrieve uploaded attached an entity of tenant terms of use")
        .setParent(Context.current().with(Span.current())).setSpanKind(SpanKind.SERVER).startSpan();
    try {
      span.setAttribute("ref", uid);
      BinaryContent stream = retrieveAttachedUploadUsecase.read(currentRequest.interaction(),
          TenantTermsOfUseReference.of(uid));
      String encodedFilename = URLEncoder.encode(stream.getName(), StandardCharsets.UTF_8);
      return Response.ok(stream.getInputStream()).header("Content-type", stream.getContentType())
          .header("Content-Disposition", "attachment; filename*=UTF-8''" + encodedFilename).build();
    } catch (RuntimeException ex) {
      span.setAttribute("error", true);
      span.recordException(ex);
      throw ex;
    } finally {
      span.end();
    }
  }

  /**
   * @autogenerated FileControllerGenerator
   * @param temp
   * @return
   */
  public Response tenantTermsOfUseApiRetrieveTempUploadAttached(final String temp) {
    Span span = tracer
        .spanBuilder("Api to retrieve temporal uploaded attached an entity of tenant terms of use")
        .setParent(Context.current().with(Span.current())).setSpanKind(SpanKind.SERVER).startSpan();
    try {
      span.setAttribute("temp-id", temp);
      BinaryContent stream = tempAttachedUploadUsecase.read(currentRequest.interaction(), temp);
      return Response.ok(stream.getInputStream()).build();
    } catch (RuntimeException ex) {
      span.setAttribute("error", true);
      span.recordException(ex);
      throw ex;
    } finally {
      span.end();
    }
  }

  /**
   * @autogenerated FileControllerGenerator
   * @param file
   * @param fileName
   * @param fileType
   * @return
   */
  public Response tenantTermsOfUseApiUploadTempUploadAttached(final InputStream file,
      final String fileName, final String fileType) {
    Span span = tracer.spanBuilder("Api to upload attached an entity of tenant terms of use")
        .setParent(Context.current().with(Span.current())).setSpanKind(SpanKind.SERVER).startSpan();
    try {
      String key = tempAttachedUploadUsecase.upload(currentRequest.interaction(),
          BinaryContent.builder().name(fileName).contentType(fileType)
              .lastModification(System.currentTimeMillis()).inputStream(file).build());
      return Response.ok(currentRequest.getPublicHost()
          + "/api/access/tenants-terms-of-use/-/temp-attached?temp=" + key).build();
    } catch (RuntimeException ex) {
      span.setAttribute("error", true);
      span.recordException(ex);
      throw ex;
    } finally {
      span.end();
    }
  }
}
