package net.civeira.phylax.features.access.trustedclient.application.importation;

import java.util.Map;
import java.util.Optional;

import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.value.validation.ConstraintFail;
import net.civeira.phylax.common.value.validation.ConstraintFailList;
import net.civeira.phylax.features.access.trustedclient.domain.TrustedClient;
import net.civeira.phylax.features.access.trustedclient.domain.TrustedClientChangeSet;
import net.civeira.phylax.features.access.trustedclient.domain.gateway.TrustedClientFilter;
import net.civeira.phylax.features.access.trustedclient.domain.gateway.TrustedClientWriteRepositoryGateway;
import net.civeira.phylax.features.access.trustedclient.domain.valueobject.EnabledVO;
import net.civeira.phylax.features.access.trustedclient.domain.valueobject.PublicAllowVO;

@RequiredArgsConstructor
public class TrustedClientImportationService {

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TrustedClientWriteRepositoryGateway repository;

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @return
   */
  public TrustedClientImportationResult load(final Map<String, String> row) {
    ConstraintFailList fails = new ConstraintFailList();
    String code = row.get("code");
    if (null == code) {
      fails.add(new ConstraintFail("NOT_NULL", "code", null));
    }
    boolean exists = false;
    TrustedClient entity = null;
    if (!fails.isEmpty()) {
      Optional<TrustedClient> existing =
          repository.findForUpdate(TrustedClientFilter.builder().code(code).build());
      TrustedClientChangeSet change = toChangeSet(row, fails);
      if (existing.isPresent()) {
        entity = existing.get().update(change);
        exists = true;
      } else {
        entity = TrustedClient.create(change.newUid());
      }
    }
    return fails.isEmpty() ? new TrustedClientImportationResult(entity, exists)
        : new TrustedClientImportationResult(fails);
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param fails
   * @return
   */
  public TrustedClientChangeSet toChangeSet(final Map<String, String> row,
      final ConstraintFailList fails) {
    TrustedClientChangeSet change = new TrustedClientChangeSet();
    change = readCode(change, row, fails);
    change = readPublicAllow(change, row, fails);
    change = readSecretOauth(change, row, fails);
    change = readEnabled(change, row, fails);
    return change;
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private TrustedClientChangeSet readCode(final TrustedClientChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String code = row.get("code");
    if (code != null) {
      return change.code(code);
    } else {
      return change.unsetCode();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private TrustedClientChangeSet readEnabled(final TrustedClientChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String enabled = row.get("enabled");
    if (enabled != null) {
      return change.enabled(EnabledVO.tryFromString(enabled, fails));
    } else {
      return change.unsetEnabled();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private TrustedClientChangeSet readPublicAllow(final TrustedClientChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String publicAllow = row.get("publicAllow");
    if (publicAllow != null) {
      return change.publicAllow(PublicAllowVO.tryFromString(publicAllow, fails));
    } else {
      return change.unsetPublicAllow();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private TrustedClientChangeSet readSecretOauth(final TrustedClientChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String secretOauth = row.get("secretOauth");
    if (secretOauth != null) {
      return change.secretOauthPlain(secretOauth);
    } else {
      return change.unsetSecretOauth();
    }
  }
}
