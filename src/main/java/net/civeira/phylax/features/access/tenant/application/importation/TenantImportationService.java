package net.civeira.phylax.features.access.tenant.application.importation;

import java.util.Map;
import java.util.Optional;

import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.value.validation.ConstraintFail;
import net.civeira.phylax.common.value.validation.ConstraintFailList;
import net.civeira.phylax.features.access.tenant.domain.Tenant;
import net.civeira.phylax.features.access.tenant.domain.TenantChangeSet;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantFilter;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantWriteRepositoryGateway;
import net.civeira.phylax.features.access.tenant.domain.valueobject.EnabledVO;
import net.civeira.phylax.features.access.tenant.domain.valueobject.MarkForDeleteTimeVO;
import net.civeira.phylax.features.access.tenant.domain.valueobject.MarkForDeleteVO;
import net.civeira.phylax.features.access.tenant.domain.valueobject.RootVO;

@RequiredArgsConstructor
public class TenantImportationService {

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantWriteRepositoryGateway repository;

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @return
   */
  public TenantImportationResult load(final Map<String, String> row) {
    ConstraintFailList fails = new ConstraintFailList();
    String name = row.get("name");
    if (null == name) {
      fails.add(new ConstraintFail("NOT_NULL", "name", null));
    }
    boolean exists = false;
    Tenant entity = null;
    if (!fails.isEmpty()) {
      Optional<Tenant> existing =
          repository.findForUpdate(TenantFilter.builder().name(name).build());
      TenantChangeSet change = toChangeSet(row, fails);
      if (existing.isPresent()) {
        entity = existing.get().update(change);
        exists = true;
      } else {
        entity = Tenant.create(change.newUid());
      }
    }
    return fails.isEmpty() ? new TenantImportationResult(entity, exists)
        : new TenantImportationResult(fails);
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param fails
   * @return
   */
  public TenantChangeSet toChangeSet(final Map<String, String> row,
      final ConstraintFailList fails) {
    TenantChangeSet change = new TenantChangeSet();
    change = readName(change, row, fails);
    change = readRoot(change, row, fails);
    change = readDomain(change, row, fails);
    change = readEnabled(change, row, fails);
    change = readMarkForDelete(change, row, fails);
    change = readMarkForDeleteTime(change, row, fails);
    return change;
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private TenantChangeSet readDomain(final TenantChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails) {
    String domain = row.get("domain");
    if (domain != null) {
      return change.domain(domain);
    } else {
      return change.unsetDomain();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private TenantChangeSet readEnabled(final TenantChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails) {
    String enabled = row.get("enabled");
    if (enabled != null) {
      return change.enabled(EnabledVO.tryFromString(enabled, fails));
    } else {
      return change.unsetEnabled();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private TenantChangeSet readMarkForDelete(final TenantChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String markForDelete = row.get("markForDelete");
    if (markForDelete != null) {
      return change.markForDelete(MarkForDeleteVO.tryFromString(markForDelete, fails));
    } else {
      return change.unsetMarkForDelete();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private TenantChangeSet readMarkForDeleteTime(final TenantChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String markForDeleteTime = row.get("markForDeleteTime");
    if (markForDeleteTime != null) {
      return change.markForDeleteTime(MarkForDeleteTimeVO.tryFromString(markForDeleteTime, fails));
    } else {
      return change.unsetMarkForDeleteTime();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private TenantChangeSet readName(final TenantChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails) {
    String name = row.get("name");
    if (name != null) {
      return change.name(name);
    } else {
      return change.unsetName();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private TenantChangeSet readRoot(final TenantChangeSet change, final Map<String, String> row,
      final ConstraintFailList fails) {
    String root = row.get("root");
    if (root != null) {
      return change.root(RootVO.tryFromString(root, fails));
    } else {
      return change.unsetRoot();
    }
  }
}
