package net.civeira.phylax.features.access.relyingparty.infrastructure.driven;

import jakarta.enterprise.context.ApplicationScoped;
import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.infrastructure.audit.AuditEvent;
import net.civeira.phylax.common.infrastructure.audit.AuditWriteService;
import net.civeira.phylax.common.security.Interaction;
import net.civeira.phylax.features.access.relyingparty.domain.RelyingParty;
import net.civeira.phylax.features.access.relyingparty.domain.gateway.RelyingPartyAuditGateway;

@ApplicationScoped
@RequiredArgsConstructor
public class RelyingPartyAuditAdapter implements RelyingPartyAuditGateway {

  /**
   * @autogenerated AuditAdapterGenerator
   */
  private final AuditWriteService writer;

  /**
   * @autogenerated AuditAdapterGenerator
   * @param usecase The usecase responsible to the action
   * @param relyingParty
   * @param interaction The interaction
   */
  @Override
  public void created(final String usecase, final RelyingParty relyingParty,
      final Interaction interaction) {
    writer.record(AuditEvent.builder().operation("create").usecase(usecase)
        .entityType("relyingParty").entityId(relyingParty.getUid()).newValue(relyingParty.toMap())
        .performedBy(interaction.getActor().getName().orElse("<<no-user>>"))
        .tenant(interaction.getActor().getTenant().orElse("<<no-tenant>>"))
        .timestamp(interaction.getConnection().getStartTime())
        .sourceRequest(interaction.getConnection().getRequest())
        .remoteAddress(interaction.getConnection().getRemote().orElse("<<no-device>>"))
        .remoteApplication(
            interaction.getConnection().getRemoteApplication().orElse("<<no-application>>"))
        .remoteDevice(interaction.getConnection().getRemoteDevice().orElse("<<no-device>>"))
        .claims(interaction.getActor().getClaims()).build());
  }

  /**
   * @autogenerated AuditAdapterGenerator
   * @param usecase The usecase responsible to the action
   * @param relyingParty
   * @param interaction The interaction
   */
  @Override
  public void deleted(final String usecase, final RelyingParty relyingParty,
      final Interaction interaction) {
    writer.record(AuditEvent.builder().operation("delete").usecase(usecase)
        .entityType("relyingParty").entityId(relyingParty.getUid()).oldValue(relyingParty.toMap())
        .performedBy(interaction.getActor().getName().orElse("<<no-user>>"))
        .tenant(interaction.getActor().getTenant().orElse("<<no-tenant>>"))
        .timestamp(interaction.getConnection().getStartTime())
        .sourceRequest(interaction.getConnection().getRequest())
        .remoteAddress(interaction.getConnection().getRemote().orElse("<<no-device>>"))
        .remoteApplication(
            interaction.getConnection().getRemoteApplication().orElse("<<no-application>>"))
        .remoteDevice(interaction.getConnection().getRemoteDevice().orElse("<<no-device>>"))
        .claims(interaction.getActor().getClaims()).build());
  }

  /**
   * @autogenerated AuditAdapterGenerator
   * @param usecase The usecase responsible to the action
   * @param relyingParty
   * @param relyingPartyOriginal
   * @param interaction The interaction
   */
  @Override
  public void updated(final String usecase, final RelyingParty relyingParty,
      final RelyingParty relyingPartyOriginal, final Interaction interaction) {
    writer.record(AuditEvent.builder().operation("update").usecase(usecase)
        .entityType("relyingParty").entityId(relyingParty.getUid()).newValue(relyingParty.toMap())
        .oldValue(relyingPartyOriginal.toMap())
        .performedBy(interaction.getActor().getName().orElse("<<no-user>>"))
        .tenant(interaction.getActor().getTenant().orElse("<<no-tenant>>"))
        .timestamp(interaction.getConnection().getStartTime())
        .sourceRequest(interaction.getConnection().getRequest())
        .remoteAddress(interaction.getConnection().getRemote().orElse("<<no-device>>"))
        .remoteApplication(
            interaction.getConnection().getRemoteApplication().orElse("<<no-application>>"))
        .remoteDevice(interaction.getConnection().getRemoteDevice().orElse("<<no-device>>"))
        .claims(interaction.getActor().getClaims()).build());
  }
}
