package net.civeira.phylax.features.access.user.infrastructure.driven;

import io.opentelemetry.api.trace.Span;
import io.opentelemetry.api.trace.SpanContext;
import jakarta.enterprise.context.ApplicationScoped;
import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.infrastructure.audit.AuditEvent;
import net.civeira.phylax.common.infrastructure.audit.AuditWriteService;
import net.civeira.phylax.common.security.Interaction;
import net.civeira.phylax.features.access.user.domain.User;
import net.civeira.phylax.features.access.user.domain.gateway.UserAuditGateway;

@ApplicationScoped
@RequiredArgsConstructor
public class UserAuditAdapter implements UserAuditGateway {

  /**
   * @autogenerated AuditAdapterGenerator
   */
  private final AuditWriteService writer;

  /**
   * @autogenerated AuditAdapterGenerator
   * @param usecase The usecase responsible to the action
   * @param user
   * @param interaction The interaction
   */
  @Override
  public void created(final String usecase, final User user, final Interaction interaction) {
    writer.record("access_user_audit",
        AuditEvent.builder().operation("create").usecase(usecase).traceId(currentTraceId())
            .spanId(currentSpanId()).entityType("user").entityId(user.getUid())
            .newValue(user.toMap())
            .performedBy(interaction.getActor().getName().orElse("<<no-user>>"))
            .tenant(interaction.getActor().getTenant().orElse("<<no-tenant>>"))
            .timestamp(interaction.getConnection().getStartTime())
            .sourceRequest(interaction.getConnection().getRequest())
            .remoteAddress(interaction.getConnection().getRemote().orElse("<<no-device>>"))
            .remoteApplication(
                interaction.getConnection().getRemoteApplication().orElse("<<no-application>>"))
            .remoteDevice(interaction.getConnection().getRemoteDevice().orElse("<<no-device>>"))
            .claims(interaction.getActor().getClaims()).build());
  }

  /**
   * @autogenerated AuditAdapterGenerator
   * @param usecase The usecase responsible to the action
   * @param user
   * @param interaction The interaction
   */
  @Override
  public void deleted(final String usecase, final User user, final Interaction interaction) {
    writer.record("access_user_audit",
        AuditEvent.builder().operation("delete").usecase(usecase).traceId(currentTraceId())
            .spanId(currentSpanId()).entityType("user").entityId(user.getUid())
            .oldValue(user.toMap())
            .performedBy(interaction.getActor().getName().orElse("<<no-user>>"))
            .tenant(interaction.getActor().getTenant().orElse("<<no-tenant>>"))
            .timestamp(interaction.getConnection().getStartTime())
            .sourceRequest(interaction.getConnection().getRequest())
            .remoteAddress(interaction.getConnection().getRemote().orElse("<<no-device>>"))
            .remoteApplication(
                interaction.getConnection().getRemoteApplication().orElse("<<no-application>>"))
            .remoteDevice(interaction.getConnection().getRemoteDevice().orElse("<<no-device>>"))
            .claims(interaction.getActor().getClaims()).build());
  }

  /**
   * @autogenerated AuditAdapterGenerator
   * @param usecase The usecase responsible to the action
   * @param user
   * @param userOriginal
   * @param interaction The interaction
   */
  @Override
  public void updated(final String usecase, final User user, final User userOriginal,
      final Interaction interaction) {
    writer.record("access_user_audit",
        AuditEvent.builder().operation("update").usecase(usecase).traceId(currentTraceId())
            .spanId(currentSpanId()).entityType("user").entityId(user.getUid())
            .newValue(user.toMap()).oldValue(userOriginal.toMap())
            .performedBy(interaction.getActor().getName().orElse("<<no-user>>"))
            .tenant(interaction.getActor().getTenant().orElse("<<no-tenant>>"))
            .timestamp(interaction.getConnection().getStartTime())
            .sourceRequest(interaction.getConnection().getRequest())
            .remoteAddress(interaction.getConnection().getRemote().orElse("<<no-device>>"))
            .remoteApplication(
                interaction.getConnection().getRemoteApplication().orElse("<<no-application>>"))
            .remoteDevice(interaction.getConnection().getRemoteDevice().orElse("<<no-device>>"))
            .claims(interaction.getActor().getClaims()).build());
  }

  /**
   * @autogenerated AuditAdapterGenerator
   * @return
   */
  private String currentSpanId() {
    String value = "<<no-span>>";
    Span current = Span.current();
    if (null != current) {
      SpanContext spanContext = current.getSpanContext();
      if (null != spanContext) {
        value = spanContext.getSpanId();
      }
    }
    return value;
  }

  /**
   * @autogenerated AuditAdapterGenerator
   * @return
   */
  private String currentTraceId() {
    String value = "<<no-trace>>";
    Span current = Span.current();
    if (null != current) {
      SpanContext spanContext = current.getSpanContext();
      if (null != spanContext) {
        value = spanContext.getTraceId();
      }
    }
    return value;
  }
}
