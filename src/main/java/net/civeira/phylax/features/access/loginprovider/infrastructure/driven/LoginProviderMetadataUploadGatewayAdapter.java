package net.civeira.phylax.features.access.loginprovider.infrastructure.driven;

import java.util.Optional;

import jakarta.enterprise.context.ApplicationScoped;
import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.infrastructure.store.BinaryContent;
import net.civeira.phylax.common.infrastructure.store.FileStore;
import net.civeira.phylax.common.infrastructure.store.RepositoryLink;
import net.civeira.phylax.features.access.loginprovider.domain.LoginProvider;
import net.civeira.phylax.features.access.loginprovider.domain.gateway.LoginProviderMetadataUploadGateway;

@ApplicationScoped
@RequiredArgsConstructor
public class LoginProviderMetadataUploadGatewayAdapter
    implements LoginProviderMetadataUploadGateway {

  /**
   * @autogenerated StoreGatewayGenerator
   */
  private final FileStore store;

  /**
   * @autogenerated StoreGatewayGenerator
   * @param key
   * @param orignal
   * @return
   */
  @Override
  public Optional<String> commitMetadata(final LoginProvider key,
      final Optional<LoginProvider> orignal) {
    String theNew = key.getMetadata().orElse(null);
    String theOld = orignal.flatMap(LoginProvider::getMetadata).orElse(null);
    boolean wasRemoved = theNew == null && theOld != null;
    boolean wasAppend = theNew != null && theOld == null;
    boolean wasModified = theOld != null && theNew != null && !theNew.equals(theOld);
    if (wasAppend) {
      return Optional.of(store.commitContent(theNew).getKey());
    } else if (wasModified) {
      store.deleteFile(theOld);
      return Optional.of(store.commitContent(theNew).getKey());
    } else if (wasRemoved) {
      return Optional
          .of(store.commitReplace(theNew, RepositoryLink.builder().key(theOld).build()).getKey());
    } else {
      return Optional.empty();
    }
  }

  /**
   * @autogenerated StoreGatewayGenerator
   * @param key
   */
  @Override
  public void deleteMetadata(final LoginProvider key) {
    key.getMetadata().ifPresent(store::deleteFile);
  }

  /**
   * @autogenerated StoreGatewayGenerator
   * @param entity
   * @return
   */
  @Override
  public Optional<BinaryContent> readMetadata(final LoginProvider entity) {
    return entity.getMetadata().map(store::retrieveFile).orElseThrow();
  }

  /**
   * @autogenerated StoreGatewayGenerator
   * @param key
   * @return
   */
  @Override
  public Optional<BinaryContent> readTemporalMetadata(final String key) {
    return store.retrieveTemp(key);
  }

  /**
   * @autogenerated StoreGatewayGenerator
   * @param content
   * @return
   */
  @Override
  public String storeTemporalMetadata(final BinaryContent content) {
    return store.tempStore(content).getKey();
  }
}
