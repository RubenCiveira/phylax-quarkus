package net.civeira.phylax.features.access.tenanttermsofuse.application.importation;

import java.util.Map;
import java.util.Optional;

import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.value.validation.ConstraintFail;
import net.civeira.phylax.common.value.validation.ConstraintFailList;
import net.civeira.phylax.features.access.tenant.domain.Tenant;
import net.civeira.phylax.features.access.tenant.domain.TenantChangeSet;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantFilter;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantReadRepositoryGateway;
import net.civeira.phylax.features.access.tenant.domain.gateway.TenantWriteRepositoryGateway;
import net.civeira.phylax.features.access.tenanttermsofuse.domain.TenantTermsOfUse;
import net.civeira.phylax.features.access.tenanttermsofuse.domain.TenantTermsOfUseChangeSet;
import net.civeira.phylax.features.access.tenanttermsofuse.domain.gateway.TenantTermsOfUseFilter;
import net.civeira.phylax.features.access.tenanttermsofuse.domain.gateway.TenantTermsOfUseWriteRepositoryGateway;
import net.civeira.phylax.features.access.tenanttermsofuse.domain.valueobject.ActivationDateVO;
import net.civeira.phylax.features.access.tenanttermsofuse.domain.valueobject.EnabledVO;

@RequiredArgsConstructor
public class TenantTermsOfUseImportationService {

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantTermsOfUseWriteRepositoryGateway repository;

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantReadRepositoryGateway tenantReadRepository;

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final TenantWriteRepositoryGateway tenantWriteRepository;

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @return
   */
  public TenantTermsOfUseImportationResult load(final Map<String, String> row) {
    return load(row, TenantTermsOfUseImportationRelatedResolver.builder().build());
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param resolver
   * @return
   */
  public TenantTermsOfUseImportationResult load(final Map<String, String> row,
      final TenantTermsOfUseImportationRelatedResolver resolver) {
    ConstraintFailList fails = new ConstraintFailList();
    String uid = row.get("uid");
    if (null == uid) {
      fails.add(new ConstraintFail("NOT_NULL", "uid", null));
    }
    boolean exists = false;
    TenantTermsOfUse entity = null;
    if (!fails.isEmpty()) {
      Optional<TenantTermsOfUse> existing =
          repository.findForUpdate(TenantTermsOfUseFilter.builder().uid(uid).build());
      TenantTermsOfUseChangeSet change = toChangeSet(row, fails, resolver);
      if (existing.isPresent()) {
        entity = existing.get().update(change);
        exists = true;
      } else {
        entity = TenantTermsOfUse.create(change.newUid());
      }
    }
    return fails.isEmpty() ? new TenantTermsOfUseImportationResult(entity, exists)
        : new TenantTermsOfUseImportationResult(fails);
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  public TenantTermsOfUseChangeSet toChangeSet(final Map<String, String> row,
      final ConstraintFailList fails, final TenantTermsOfUseImportationRelatedResolver resolver) {
    TenantTermsOfUseChangeSet change = new TenantTermsOfUseChangeSet();
    change = readTenant(change, row, fails, resolver);
    change = readText(change, row, fails, resolver);
    change = readEnabled(change, row, fails, resolver);
    change = readActivationDate(change, row, fails, resolver);
    return change;
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantTermsOfUseChangeSet readActivationDate(final TenantTermsOfUseChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantTermsOfUseImportationRelatedResolver resolver) {
    String activationDate = row.get("activationDate");
    if (activationDate != null) {
      return change.activationDate(ActivationDateVO.tryFromString(activationDate, fails));
    } else {
      return change.unsetActivationDate();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantTermsOfUseChangeSet readEnabled(final TenantTermsOfUseChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantTermsOfUseImportationRelatedResolver resolver) {
    String enabled = row.get("enabled");
    if (enabled != null) {
      return change.enabled(EnabledVO.tryFromString(enabled, fails));
    } else {
      return change.unsetEnabled();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantTermsOfUseChangeSet readTenant(final TenantTermsOfUseChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantTermsOfUseImportationRelatedResolver resolver) {
    String tenant = row.get("tenant");
    if (tenant != null) {
      Optional<Tenant> existing =
          tenantReadRepository.find(TenantFilter.builder().name(tenant).build());
      if (existing.isPresent()) {
        return change.tenant(existing.get());
      } else if (resolver.isCreateMissingTenant()) {
        TenantChangeSet childChanges = new TenantChangeSet().newUid();
        Tenant entity = (null == resolver.getMissingTenantFactory()) ? Tenant.create(childChanges)
            : resolver.getMissingTenantFactory().apply(childChanges);
        return change.tenant(tenantWriteRepository.create(entity));
      } else {
        fails.add(new ConstraintFail("NOT_FOUND", "tenant", tenant));
        return change;
      }
    } else {
      return change.unsetTenant();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @param resolver
   * @return
   */
  private TenantTermsOfUseChangeSet readText(final TenantTermsOfUseChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails,
      final TenantTermsOfUseImportationRelatedResolver resolver) {
    String text = row.get("text");
    if (text != null) {
      return change.text(text);
    } else {
      return change.unsetText();
    }
  }
}
