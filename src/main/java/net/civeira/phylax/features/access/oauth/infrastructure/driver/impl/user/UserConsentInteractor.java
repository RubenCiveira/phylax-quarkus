/* @autogenerated */
package net.civeira.phylax.features.access.oauth.infrastructure.driver.impl.user;

import java.util.List;
import java.util.Locale;
import java.util.Optional;

import jakarta.enterprise.context.ApplicationScoped;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import net.civeira.phylax.features.access.oauth.application.usecase.PendingConsentUsecase;
import net.civeira.phylax.features.oauth.authentication.domain.AuthRequest;
import net.civeira.phylax.features.oauth.user.domain.PendingConsent;
import net.civeira.phylax.features.oauth.user.domain.gateway.ConsentGateway;

@Transactional
@ApplicationScoped
@RequiredArgsConstructor
public class UserConsentInteractor implements ConsentGateway {
  private final PendingConsentUsecase pending;

  @Override
  public Optional<PendingConsent> getPendingConsent(String tenant, String username,
      List<String> audiences, Locale locale) {
    AuthRequest request =
        AuthRequest.builder().tenant(tenant).audiences(audiences).locale(locale).build();
    String firstAudience = audiences != null && !audiences.isEmpty() ? audiences.get(0) : "";
    return pending.userRequiredConsent(request, locale, username)
        .map(text -> PendingConsent.of(firstAudience, text));
  }

  @Override
  public void storeAcceptedConsent(String tenant, String username, String relyingParty) {
    AuthRequest request =
        AuthRequest.builder().tenant(tenant).audiences(List.of(relyingParty)).build();
    pending.confirmConsent(request, username, null);
  }
}
