package net.civeira.phylax.features.access.relyingparty.application.importation;

import java.util.Map;
import java.util.Optional;

import lombok.RequiredArgsConstructor;
import net.civeira.phylax.common.value.validation.ConstraintFail;
import net.civeira.phylax.common.value.validation.ConstraintFailList;
import net.civeira.phylax.features.access.relyingparty.domain.RelyingParty;
import net.civeira.phylax.features.access.relyingparty.domain.RelyingPartyChangeSet;
import net.civeira.phylax.features.access.relyingparty.domain.gateway.RelyingPartyFilter;
import net.civeira.phylax.features.access.relyingparty.domain.gateway.RelyingPartyWriteRepositoryGateway;
import net.civeira.phylax.features.access.relyingparty.domain.valueobject.EnabledVO;

@RequiredArgsConstructor
public class RelyingPartyImportationService {

  /**
   * @autogenerated VisibilityFilterGenerator
   */
  private final RelyingPartyWriteRepositoryGateway repository;

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @return
   */
  public RelyingPartyImportationResult load(final Map<String, String> row) {
    ConstraintFailList fails = new ConstraintFailList();
    String code = row.get("code");
    if (null == code) {
      fails.add(new ConstraintFail("NOT_NULL", "code", null));
    }
    boolean exists = false;
    RelyingParty entity = null;
    if (!fails.isEmpty()) {
      Optional<RelyingParty> existing =
          repository.findForUpdate(RelyingPartyFilter.builder().code(code).build());
      RelyingPartyChangeSet change = toChangeSet(row, fails);
      if (existing.isPresent()) {
        entity = existing.get().update(change);
        exists = true;
      } else {
        entity = RelyingParty.create(change.newUid());
      }
    }
    return fails.isEmpty() ? new RelyingPartyImportationResult(entity, exists)
        : new RelyingPartyImportationResult(fails);
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param row
   * @param fails
   * @return
   */
  public RelyingPartyChangeSet toChangeSet(final Map<String, String> row,
      final ConstraintFailList fails) {
    RelyingPartyChangeSet change = new RelyingPartyChangeSet();
    change = readCode(change, row, fails);
    change = readApiKey(change, row, fails);
    change = readEnabled(change, row, fails);
    return change;
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private RelyingPartyChangeSet readApiKey(final RelyingPartyChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String apiKey = row.get("apiKey");
    if (apiKey != null) {
      return change.apiKey(apiKey);
    } else {
      return change.unsetApiKey();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private RelyingPartyChangeSet readCode(final RelyingPartyChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String code = row.get("code");
    if (code != null) {
      return change.code(code);
    } else {
      return change.unsetCode();
    }
  }

  /**
   * @autogenerated VisibilityFilterGenerator
   * @param change
   * @param row
   * @param fails
   * @return
   */
  private RelyingPartyChangeSet readEnabled(final RelyingPartyChangeSet change,
      final Map<String, String> row, final ConstraintFailList fails) {
    String enabled = row.get("enabled");
    if (enabled != null) {
      return change.enabled(EnabledVO.tryFromString(enabled, fails));
    } else {
      return change.unsetEnabled();
    }
  }
}
