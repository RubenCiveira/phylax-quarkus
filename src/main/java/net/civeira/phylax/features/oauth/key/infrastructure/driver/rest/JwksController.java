/* @autogenerated */
package net.civeira.phylax.features.oauth.key.infrastructure.driver.rest;

import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;

import jakarta.enterprise.context.RequestScoped;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.PathParam;
import jakarta.ws.rs.core.CacheControl;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.EntityTag;
import jakarta.ws.rs.core.Request;
import jakarta.ws.rs.core.Response;
import lombok.RequiredArgsConstructor;
import net.civeira.phylax.features.oauth.key.domain.gateway.TokenSigner;
import net.civeira.phylax.features.oauth.key.domain.model.JwkSet;

@Path("")
@RequestScoped
@RequiredArgsConstructor
public class JwksController {
  private final TokenSigner tokenSigner;
  private final ObjectMapper mapper;

  @GET
  @Path("oauth/openid/{tenant}/jwks")
  public Response jwks(final @PathParam("tenant") String tenant, @Context Request request) {
    JwkSet jwkSet = tokenSigner.keysAsJwks(tenant);
    EntityTag etag = new EntityTag(hash(jwkSet));
    CacheControl cacheControl = new CacheControl();
    cacheControl.setMaxAge(3600);

    Response.ResponseBuilder notModified = request.evaluatePreconditions(etag);
    if (notModified != null) {
      return notModified.cacheControl(cacheControl).build();
    }
    return Response.ok(jwkSet).cacheControl(cacheControl).tag(etag).build();
  }

  private String hash(JwkSet jwkSet) {
    try {
      String payload = mapper.writeValueAsString(jwkSet);
      MessageDigest digest = MessageDigest.getInstance("SHA-256");
      byte[] hash = digest.digest(payload.getBytes(StandardCharsets.UTF_8));
      return java.util.Base64.getUrlEncoder().withoutPadding().encodeToString(hash);
    } catch (JsonProcessingException | NoSuchAlgorithmException ex) {
      throw new IllegalStateException("Unable to hash JWKS payload", ex);
    }
  }
}
