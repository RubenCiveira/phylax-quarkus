/* @autogenerated */
package net.civeira.phylax.features.oauth.authentication.application.granter;

import java.util.Arrays;
import java.util.List;
import java.util.Map;

import jakarta.enterprise.context.RequestScoped;
import lombok.RequiredArgsConstructor;
import net.civeira.phylax.features.oauth.authentication.domain.AuthRequest;
import net.civeira.phylax.features.oauth.authentication.domain.AuthenticationResult;
import net.civeira.phylax.features.oauth.client.domain.ClientDetails;
import net.civeira.phylax.features.oauth.delegated.application.DelegateLogin;
import net.civeira.phylax.features.oauth.user.application.LoginUsecase;

@RequestScoped
@RequiredArgsConstructor
public class DelegatedAccessGranter implements TokenGranter {

  private final DelegateLogin delegateLogin;
  private final LoginUsecase loginUsecase;

  @Override
  public boolean canHandle(String grantType) {
    return "delegated".equalsIgnoreCase(grantType);
  }

  @Override
  public AuthenticationResult autenticate(final AuthRequest request, ClientDetails client,
      Map<String, List<String>> paramMap) {
    String tenant = request.getTenant();
    String token = first(paramMap, "token");
    return delegateLogin.resolveUsername(request, token).map(username -> {
      AuthenticationResult result =
          loginUsecase.fillPreAuthenticated(request, username, client, Arrays.asList());
      if (result.isRight()) {
        return loginUsecase.fillPreAuthenticated(request, result.getData().getUsername(), client,
            Arrays.asList());
      }
      return AuthenticationResult.unknownName(tenant, token);
    }).orElse(AuthenticationResult.unknownName(tenant, token));
  }

  private String first(Map<String, List<String>> paramMap, String key) {
    return paramMap.containsKey(key) || paramMap.get(key).size() > 0 ? paramMap.get(key).get(0)
        : null;
  }
}
