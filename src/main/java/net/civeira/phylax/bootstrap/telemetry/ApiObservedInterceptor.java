/* @autogenerated */
package net.civeira.phylax.bootstrap.telemetry;

import java.lang.reflect.Method;

import io.opentelemetry.api.trace.SpanKind;
import io.opentelemetry.api.trace.Tracer;
import jakarta.annotation.Priority;
import jakarta.enterprise.inject.Instance;
import jakarta.inject.Inject;
import jakarta.interceptor.AroundInvoke;
import jakarta.interceptor.Interceptor;
import jakarta.interceptor.InvocationContext;
import net.civeira.phylax.common.telemetry.ApiObserved;

@ApiObserved
@Interceptor
@Priority(Interceptor.Priority.APPLICATION + 10)
public class ApiObservedInterceptor {
  @Inject
  Instance<Tracer> tracerInstance;

  @AroundInvoke
  public Object around(final InvocationContext context) throws Exception {
    ApiObserved observed = resolveObserved(context);
    if (observed == null) {
      return context.proceed();
    }
    return TelemetryInterceptor.around(context, tracerInstance, SpanKind.SERVER, observed.value(),
        observed.value());
  }

  private ApiObserved resolveObserved(final InvocationContext context) {
    Method method = context.getMethod();
    if (method != null && method.isAnnotationPresent(ApiObserved.class)) {
      return method.getAnnotation(ApiObserved.class);
    }
    return null;
  }

}
