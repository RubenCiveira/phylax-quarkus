/* @autogenerated */
package net.civeira.phylax.bootstrap.rate;

import io.github.bucket4j.Bucket;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.ws.rs.container.ContainerRequestContext;
import jakarta.ws.rs.container.ContainerRequestFilter;
import jakarta.ws.rs.container.ContainerResponseContext;
import jakarta.ws.rs.container.ContainerResponseFilter;
import jakarta.ws.rs.core.Response;
import jakarta.ws.rs.ext.Provider;
import lombok.RequiredArgsConstructor;

@Provider
@ApplicationScoped
@RequiredArgsConstructor
public class RateLimitingFilter implements ContainerRequestFilter, ContainerResponseFilter {

  private final BucketService buckets;

  @Override
  public void filter(ContainerRequestContext requestContext) {
    Bucket bucket = buckets.resolveBucket(requestContext);
    // Verificar si hay tokens disponibles
    if (!bucket.tryConsume(1)) {
      // Limitar la solicitud si no hay tokens
      Response response =
          Response.status(Response.Status.TOO_MANY_REQUESTS).entity("Too many requests").build();
      requestContext.abortWith(response);
    }
  }

  public void filter(ContainerRequestContext requestContext,
      ContainerResponseContext responseContext) {
    // Añadir cabeceras de información al cliente
    Bucket bucket = buckets.resolveBucket(requestContext);
    responseContext.getHeaders().add("X-RateLimit-Remaining",
        String.valueOf(bucket.getAvailableTokens()));
  }
}
